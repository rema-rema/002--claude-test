# 実装タスクリスト

## 🚨 重要な前提条件

### 現在の実装状況
- ✅ **基本チャット機能は完全に動作しています**
- ✅ **OpenAI API統合は正常に機能しています**
- ✅ **Fly.io デプロイは成功しています**

### 実装方針
- **現在のコードを正として扱う**: 既存機能は完璧に動作する前提
- **段階的改善**: 一度に大きな変更は行わない
- **動作保証**: リファクタリング後も既存機能は必ず動作する
- **明示的指示**: このタスクリスト以外の実装は行わない

## 概要
現在のAIチャットアプリケーションの改善・拡張・保守に関する実装タスクを定義します。現在の実装を基に、段階的な改善と将来の拡張準備を行います。

**⚠️ 注意: 設計書に記載されていても、このタスクリストにないものは実装対象外です**

## フェーズ1: コード品質向上・リファクタリング（即座に実行推奨）

### 1.1 型定義の整理・共通化
- [ ] `src/types/index.ts` 作成してMessage型を共通化
  - ChatInterface.tsxのMessage型を`src/types/common.ts`に移動
  - API通信用の型定義を`src/types/api.ts`に作成
  - 基本型エイリアス（MessageId, Timestamp等）の定義
  - _現在の問題: 型定義が分散、再利用困難_

- [ ] ChatInterfaceコンポーネントのProps型定義
  - ChatInterfacePropsインターフェースの明示的定義
  - 将来のコンポーネント分離に備えた型設計
  - _現在の問題: Props型が未定義_

### 1.2 バックエンドコード構造改善
- [ ] エラーレスポンス形式の統一
  - 現在の`{"error": "message"}`形式を統一的な形式に変更
  - エラーコード体系の導入準備
  - _現在の問題: エラー形式が不統一_

- [ ] OpenAI API呼び出しの関数化
  - `chat()`関数内のOpenAI API呼び出し部分を独立した関数に分離
  - 設定値（model, temperature, max_tokens）の外部化
  - _現在の問題: ビジネスロジックがルートハンドラーに混在_

- [ ] バリデーション処理の共通化
  - リクエスト検証ロジックの関数化
  - 入力値検証の強化（文字数制限、形式チェック等）
  - _現在の問題: バリデーションが散在_

### 1.3 フロントエンドコンポーネント分離
- [ ] ChatInterfaceコンポーネントの分離
  - MessageListコンポーネントの分離（メッセージ表示部分）
  - MessageInputコンポーネントの分離（入力部分）
  - LoadingIndicatorコンポーネントの分離（ローディング表示）
  - _現在の問題: 単一コンポーネントに機能が集中_

- [ ] カスタムフック（useChat）の作成
  - ChatInterface内のロジックをuseChatフックに分離
  - API通信ロジックの抽象化
  - 状態管理の分離
  - _現在の問題: UIとロジックが混在_

## フェーズ2: 機能拡張・改善

### 2.1 チャット機能の拡張
- [ ] チャット設定の動的変更機能
  - モデル選択（gpt-4, gpt-3.5-turbo）
  - 温度設定の調整
  - 最大トークン数の設定
  - _拡張理由: ユーザーの用途に応じた調整が必要_

- [ ] メッセージのコピー機能
  - 各メッセージにコピーボタン追加
  - クリップボードAPI使用
  - _拡張理由: AI応答の再利用ニーズ_

- [ ] チャット履歴のエクスポート機能
  - JSON形式でのエクスポート
  - テキスト形式でのエクスポート
  - _拡張理由: データの外部利用ニーズ_

### 2.2 UI/UX改善
- [ ] ダークモード/ライトモードの実装
  - テーマ切り替え機能
  - システム設定との連動
  - _拡張理由: ユーザビリティ向上_

- [ ] レスポンシブデザインの改善
  - モバイル表示の最適化
  - タブレット表示の調整
  - _現在の問題: モバイルでの使いやすさに改善余地_

- [ ] キーボードショートカットの実装
  - Ctrl+Enter での送信
  - Esc でのクリア
  - _拡張理由: パワーユーザーの効率向上_

### 2.3 エラーハンドリング・ログ改善
- [ ] 詳細なエラーログの実装
  - 構造化ログ（JSON形式）の導入
  - リクエストID追跡機能
  - _現在の問題: デバッグ情報が不足_

- [ ] ユーザーフレンドリーなエラーメッセージ
  - エラー種別に応じたメッセージ表示
  - 復旧方法の提示
  - _現在の問題: エラーメッセージが技術的すぎる_

## フェーズ3: テスト実装

### 3.1 フロントエンドテスト
- [ ] Jest + React Testing Library のセットアップ
  - テスト環境の構築
  - 基本的なテスト設定
  - _必要性: コード品質保証_

- [ ] ChatInterfaceコンポーネントのテスト
  - メッセージ送信のテスト
  - ローディング状態のテスト
  - エラー状態のテスト
  - _必要性: 主要機能の動作保証_

### 3.2 バックエンドテスト
- [ ] pytest のセットアップ
  - テスト環境の構築
  - モック設定
  - _必要性: API動作保証_

- [ ] /api/chat エンドポイントのテスト
  - 正常系のテスト
  - 異常系のテスト（バリデーションエラー、OpenAI APIエラー）
  - _必要性: 主要API機能の動作保証_

## フェーズ4: 監視・運用改善

### 4.1 監視機能の実装
- [ ] ヘルスチェックの詳細化
  - OpenAI API接続状況の確認
  - レスポンス時間の監視
  - _必要性: サービス状態の可視化_

- [ ] 使用量監視の実装
  - OpenAI API使用量の記録
  - コスト計算機能
  - _必要性: コスト管理_

### 4.2 パフォーマンス最適化
- [ ] API レスポンス時間の最適化
  - OpenAI API呼び出しの最適化
  - 不要な処理の削除
  - _必要性: ユーザー体験向上_

- [ ] フロントエンドバンドルサイズの最適化
  - 不要な依存関係の削除
  - コード分割の実装
  - _必要性: 初期読み込み時間短縮_

## フェーズ5: 将来拡張の準備

### 5.1 認証システム準備
- [ ] 認証ミドルウェアの基盤実装
  - JWT処理の基盤作成
  - 認証フローの設計
  - _将来必要性: ユーザー管理機能_

### 5.2 データベース統合準備
- [ ] データベース抽象化レイヤーの実装
  - Repository パターンの基盤作成
  - データモデルの基本実装
  - _将来必要性: データ永続化_

### 5.3 セッション管理準備
- [ ] セッション管理の基盤実装
  - セッション概念の導入
  - 履歴管理機能の準備
  - _将来必要性: 複数チャット管理_

## 実装優先度ガイド

### 🔴 高優先度（即座に実行推奨）
- 型定義の整理・共通化
- エラーレスポンス形式の統一
- OpenAI API呼び出しの関数化
- コンポーネント分離

### 🟡 中優先度（機能拡張フェーズ）
- チャット機能の拡張
- UI/UX改善
- テスト実装

### 🟢 低優先度（将来拡張準備）
- 認証システム準備
- データベース統合準備
- 高度な監視機能

## 🛡️ 実装時の厳格なルール

### 絶対に守るべきこと
1. **既存機能の動作保証**
   - チャット機能は常に動作する状態を維持
   - リファクタリング前後で動作確認必須
   - 問題が発生したら即座に元に戻す

2. **段階的変更の徹底**
   - 一度に1つのタスクのみ実行
   - 大きな変更は小さなステップに分割
   - 各ステップで動作確認

3. **明示的指示の遵守**
   - このタスクリスト以外は実装しない
   - 「ついでに」「こうした方が良い」は禁止
   - 疑問があれば必ず確認

### 実装前チェックリスト
- [ ] 対象タスクがこのリストに明記されている
- [ ] 現在の動作を理解している
- [ ] 変更による影響範囲を把握している
- [ ] ロールバック方法を確認している

### 実装後チェックリスト
- [ ] 基本チャット機能が正常動作
- [ ] エラーが発生していない
- [ ] 既存のテストが通る（ある場合）
- [ ] 新しい機能が期待通り動作

### コード品質基準
- TypeScript の厳密な型チェックを維持
- 既存のコードスタイルに合わせる
- 適切なコメントとドキュメント
- 不要なコードは削除しない（動作に影響する可能性）