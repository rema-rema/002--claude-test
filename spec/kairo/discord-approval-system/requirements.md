# Discord承認制システム 要件定義書

## 概要

Playwright テストが失敗した際に、Discord チャンネルを通じて自動的に原因分析・修正提案を行い、承認を得て修正を実行するシステム。思考の妨害を避けるため、実行結果と承認依頼を別チャンネルに分離する。

## ユーザストーリー

### ストーリー1: テスト失敗時の自動分析と修正提案

- **である** 開発者 **として**
- **私は** テストが失敗した時に自動的に原因分析と修正提案を受け取りたい **をしたい**
- **そうすることで** 迅速な問題解決と品質向上を実現できる

### ストーリー2: 承認制による安全な修正実行

- **である** 開発者 **として**
- **私は** 提案された修正内容を確認・承認してから実行したい **をしたい**
- **そうすることで** 予期しない変更を防ぎ、コード品質を保てる

### ストーリー3: チャンネル分離による効率的な作業

- **である** 開発者 **として**
- **私は** テスト結果と承認依頼を別チャンネルで受け取りたい **をしたい**
- **そうすることで** 思考を妨げられることなく作業に集中できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは Playwright テスト結果を `CC_DISCORD_CHANNEL_ID_002_RESULT` チャンネルに送信しなければならない
- REQ-002: システムは テスト失敗時に原因分析を自動実行しなければならない
- REQ-003: システムは 分析結果に基づいて修正提案を生成しなければならない
- REQ-004: システムは 承認依頼を `CC_DISCORD_CHANNEL_ID_002` チャンネルに送信しなければならない

### 条件付き要件

- REQ-101: テストが失敗した場合、システムは詳細な失敗理由を分析しなければならない
- REQ-102: 複数のテストが失敗した場合、システムは各テストの失敗を個別に分析しなければならない
- REQ-103: 承認が得られた場合、システムは提案された修正を実行しなければならない
- REQ-104: 承認が拒否された場合、システムは修正を実行してはならない

### 条件付き要件（追加）

- REQ-105: 実装作業中にエラーが発生した場合、システムは自動的にエラー解決を試行しなければならない
- REQ-106: 同一エラーに対して10回修正しても解決できない場合、システムは承認依頼を送信してもよい

### 制約要件（追加）

- REQ-405: システムは モードに関係なく承認制フローを適用しなければならない

### オプション要件

- REQ-301: システムは修正提案の代替案を複数提示してもよい
- REQ-302: システムは過去の類似失敗パターンから学習してもよい

### 制約要件

- REQ-401: システムは CLAUDE.md のルールに従って動作しなければならない
- REQ-402: システムは tsumiki フレームワークの順序（要件定義→設計→task→実装→テスト）を厳守しなければならない
- REQ-403: システムは 無承認での実装変更を禁止しなければならない
- REQ-404: システムは 自動エラー解決を最大10回まで試行しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: システムは テスト失敗検知から承認依頼送信まで30秒以内に完了しなければならない
- NFR-002: システムは 承認受信から修正実行まで5秒以内に開始しなければならない

### セキュリティ

- NFR-101: システムは Discord API 認証情報を安全に管理しなければならない
- NFR-102: システムは 承認権限を持つユーザーのみからの承認を受け付けなければならない

### ユーザビリティ

- NFR-201: 承認依頼メッセージは問題の概要、原因、修正提案を明確に記載しなければならない
- NFR-202: テスト結果と承認依頼の紐づけ情報を分かりやすく表示しなければならない

### 可用性

- NFR-301: システムは Discord API の一時的な障害に対して再試行機能を持たなければならない
- NFR-302: システムは 承認待ち状態を適切に管理しなければならない

## Edgeケース

### エラー処理

- EDGE-001: Discord API が利用できない場合、ローカルログに記録し後で再送信する
- EDGE-002: 承認タイムアウト（24時間）が発生した場合、自動的にキャンセル処理を実行する
- EDGE-003: 同一テストの連続失敗（5回以上）の場合、アラート強度を上げる

### 境界値

- EDGE-101: メッセージ長が Discord の制限（2000文字）を超える場合、複数メッセージに分割する
- EDGE-102: 添付ファイルサイズが制限（25MB）を超える場合、圧縮または分割送信する

### 競合状態

- EDGE-201: 同時に複数のテスト失敗が発生した場合、各々を独立して処理する
- EDGE-202: 承認処理中に新たな失敗が発生した場合、キューで管理する

## 受け入れ基準

### 機能テスト

- [ ] テスト失敗時に `CC_DISCORD_CHANNEL_ID_002_RESULT` に結果が送信される
- [ ] テスト失敗時に `CC_DISCORD_CHANNEL_ID_002` に承認依頼が送信される
- [ ] 承認依頼に問題概要、原因分析、修正提案が含まれる
- [ ] テスト結果と承認依頼の紐づけ情報が正確に表示される
- [ ] 承認後に提案された修正が実行される
- [ ] 拒否時に修正が実行されない
- [ ] テスト成功時は承認依頼が送信されない

### 非機能テスト

- [ ] 失敗検知から承認依頼送信まで30秒以内に完了する
- [ ] Discord メッセージの文字数制限内で情報が適切に表示される
- [ ] 大きな添付ファイルが適切に処理される
- [ ] API 障害時の再試行処理が動作する

### セキュリティテスト

- [ ] 不正な承認要求が拒否される
- [ ] Discord トークンが安全に管理される

### 統合テスト

- [ ] Playwright テストとの連携が正常に動作する
- [ ] 既存の Discord 通知システムとの共存ができる
- [ ] tsumiki フレームワークとの統合が問題なく動作する

## データフロー

1. **テスト実行** → Playwright テスト実行
2. **結果送信** → `CC_DISCORD_CHANNEL_ID_002_RESULT` にテスト結果送信
3. **失敗分析** → テスト失敗の場合、原因自動分析実行
4. **修正提案** → 分析結果に基づく修正案生成
5. **承認依頼** → `CC_DISCORD_CHANNEL_ID_002` に承認依頼送信
6. **承認処理** → 開発者による承認・拒否の判断
7. **修正実行** → 承認時のみ修正実行、拒否時は処理終了

## 技術制約

- Node.js ES Modules 環境での動作
- Discord.js v14 以降の使用
- Playwright Reporter API の活用
- 既存の環境変数設定の活用
- Git コミット・プッシュの自動化対応