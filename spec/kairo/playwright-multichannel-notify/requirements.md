# Playwright-Discord マルチチャンネル通知システム 要件定義書

## 1. プロジェクト概要

### 1.1 背景・目的
- **背景**: 現在のPlaywright Discord通知システムは固定チャンネル設定で、マルチセッション環境に対応していない
- **目的**: Discord Bridgeのマルチセッション環境で、Playwrightテスト結果を適切なチャンネルに自動通知する

### 1.2 解決すべき課題
- チャンネル1でテスト実行 → チャンネル1に結果通知
- チャンネル2でテスト実行 → チャンネル2に結果通知  
- チャンネル動的追加時の自動対応

## 2. 機能要件

### 2.1 コア機能

#### F001: 動的チャンネル検出
- **要件**: テスト実行時に呼び出し元のDiscordチャンネルを自動検出
- **入力**: 環境変数からチャンネル設定を取得
- **処理**: .envファイルの`CC_DISCORD_CHANNEL_ID_*`パターンをパース
- **出力**: セッション→チャンネルIDマッピング

#### F002: テスト結果通知
- **要件**: 検出したチャンネルにテスト結果を送信
- **通知内容**:
  - ✅ テスト成功/失敗サマリー
  - ❌ エラー詳細（失敗時）
  - 📹 動画ファイル（失敗時）
  - 📸 スクリーンショット（失敗時）
  - 📊 詳細分析レポート（失敗時）

#### F003: 動的設定管理
- **要件**: チャンネル追加時の設定自動反映
- **動作**: 
  - .env追加 → 再起動不要で自動認識
  - 新セッション作成時の自動対応

### 2.2 非機能要件

#### NF001: パフォーマンス
- チャンネル検出処理時間: < 100ms
- 通知送信処理時間: < 5秒

#### NF002: 可用性
- 設定エラー時のフォールバック機能
- 通知失敗時のリトライ機構

#### NF003: 拡張性
- 新チャンネル形式への対応可能性
- 他通知チャネル（Slack等）への拡張可能性

## 3. 制約条件

### 3.1 技術制約
- 既存Discord Bridge アーキテクチャとの互換性維持
- Node.js/JavaScriptによる実装
- 既存のPlaywright Reporter インターフェース準拠

### 3.2 運用制約
- .env設定形式の維持（既存フォーマット）
- 既存セッション管理システムとの連携

## 4. ユースケース

### UC001: 基本テスト実行フロー
```
1. ユーザーがチャンネル2でPlaywrightテスト実行依頼
2. Claude CodeがPlaywrightテスト実行
3. システムがセッション2 = チャンネル2を自動検出
4. テスト結果をチャンネル2に送信
```

### UC002: テスト失敗時フロー
```
1. Playwrightテストが失敗
2. 失敗分析・動画・スクリーンショット収集
3. 詳細レポート作成
4. 実行元チャンネルに包括的な失敗レポート送信
```

### UC003: 新チャンネル追加時フロー
```
1. 管理者が.envに新チャンネル設定追加
2. システムが次回実行時に新設定を自動検出
3. 新チャンネルでの通知機能が利用可能
```

## 5. 成功基準

### 5.1 機能成功基準
- ✅ マルチチャンネルでの正確な通知送信 (成功率 > 95%)
- ✅ チャンネル自動検出の精度 (100%)
- ✅ 動画・スクリーンショット添付成功率 (> 90%)

### 5.2 品質成功基準
- 🚀 レスポンス時間要件達成
- 🔧 エラー時の適切なフォールバック動作
- 📈 新チャンネル追加時の自動対応

## 6. 想定ユーザー
- **Primary**: Discord Bridge経由でClaude Code使用する開発者
- **Secondary**: システム管理者（設定管理担当）

## 7. 想定環境
- **実行環境**: GitHub Codespaces
- **通知環境**: Discord (複数チャンネル)  
- **依存システム**: claude-discord-bridge-server, Playwright

---

**文書バージョン**: v1.0  
**作成日**: 2025-08-28  
**最終更新**: 2025-08-28