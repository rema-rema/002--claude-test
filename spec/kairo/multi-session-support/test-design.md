# マルチセッション機能 テスト設計書

## 📋 概要

**対象機能**: Claude-Discord Bridge マルチセッション機能  
**テスト目的**: 要件定義書SC-001～006成功基準の完全検証  
**テスト環境**: 開発環境（/workspaces/002--claude-test）  
**テスト期間**: 実装完了後～リリース前  

## 🎯 テスト対象・範囲

### 対象コンポーネント
- **SessionManager**: セッション管理・マッピング機能
- **AttachmentManager**: セッション別添付ファイル管理
- **TmuxManager**: セッション復旧・監視機能
- **DiscordBot**: メッセージルーティング・UI
- **CLI Tools**: dp, vai コマンド機能

### 除外対象
- Discord API外部依存機能（モック使用）
- Anthropic Claude API外部依存機能（モック使用）
- 外部ネットワーク依存機能

## 🧪 テスト分類・戦略

### 1. 機能テスト（Functional Tests）
**目的**: SC-001基本機能の検証  
**手法**: 手動テスト + 自動化スクリプト  
**実行頻度**: コミット毎

### 2. セキュリティテスト（Security Tests）  
**目的**: SC-002セキュリティ・復旧機能の検証  
**手法**: 攻撃シナリオ + 権限検証  
**実行頻度**: リリース前

### 3. パフォーマンステスト（Performance Tests）
**目的**: SC-003パフォーマンス・リソース管理の検証  
**手法**: 負荷生成 + メトリクス収集  
**実行頻度**: 週次

### 4. 安定性テスト（Stability Tests）
**目的**: SC-004運用性・安定性の検証  
**手法**: 長時間稼働 + リソース監視  
**実行頻度**: リリース前

### 5. 監視・ログテスト（Monitoring Tests）
**目的**: SC-005監視・ログ機能の検証  
**手法**: ログ検証 + アラート確認  
**実行頻度**: 日次

### 6. 拡張性テスト（Scalability Tests）  
**目的**: SC-006拡張性検証  
**手法**: 段階的セッション追加テスト  
**実行頻度**: リリース前

## 📊 テストケース設計

## TC-001: 基本機能テスト (SC-001対応)

### TC-001-01: 4セッション同時稼働テスト
**目的**: 初期4セッションの同時稼働確認  
**前提条件**: システム初期状態  
**手順**:
1. `./bin/vai` でサービス起動
2. `./bin/vai status` で4セッション状態確認
3. 各セッションでClaude Code操作実行
4. セッション間の独立性確認

**期待結果**:
- 4セッション全て ✅ Running状態
- セッション間でコマンド競合なし
- 各セッションで独立したClaude Code実行

**合格基準**: 4セッション全て30分以上安定稼働

### TC-001-02: セッション別添付ファイル管理テスト
**目的**: session_N/ディレクトリ分離確認  
**前提条件**: 4セッション稼働中  
**手順**:
1. セッション1で添付ファイルアップロード → `session_1/`保存確認
2. セッション2で添付ファイルアップロード → `session_2/`保存確認  
3. セッション3,4でも同様確認
4. セッション間でファイル混在なし確認

**期待結果**:
- 各セッションファイルが正しいディレクトリに保存
- セッション間でファイル混在なし
- ファイル権限設定適切（700, 644）

**合格基準**: 10ファイル×4セッション=40ファイル正常分離

### TC-001-03: dpコマンドセッション指定テスト  
**目的**: dp N形式での正確なセッション指定確認  
**前提条件**: 4セッション設定済み  
**手順**:
1. `dp "デフォルトテスト"` → セッション1送信確認
2. `dp 2 "セッション2テスト"` → セッション2送信確認
3. `dp 3 "セッション3テスト"` → セッション3送信確認
4. `dp 4 "セッション4テスト"` → セッション4送信確認
5. `dp 999 "無効セッション"` → エラーメッセージ確認

**期待結果**:
- 各コマンドが正しいセッションに送信
- 無効セッション時に適切なエラー表示
- 利用可能セッション案内表示

**合格基準**: 100回実行で100%正確なルーティング

### TC-001-04: セッション動的追加テスト
**目的**: セッション5以降の動的追加確認  
**前提条件**: 基本4セッション稼働  
**手順**:
1. `./bin/vai add-session 5555555555555555555` 実行
2. sessions.jsonにセッション5追加確認
3. `session_5/`ディレクトリ作成確認
4. `dp 5 "新セッションテスト"` 送信確認

**期待結果**:
- sessions.jsonに新エントリ追加
- session_5/ディレクトリ自動作成
- セッション5で正常メッセージ送信

**合格基準**: セッション10まで段階的追加成功

## TC-002: セキュリティ・復旧機能テスト (SC-002対応)

### TC-002-01: セッション間ファイルアクセス権分離テスト
**目的**: セッション間でのファイル分離確認  
**前提条件**: 複数セッション稼働中  
**手順**:
1. セッション1でファイル作成 → 権限700確認
2. セッション2からセッション1ディレクトリアクセス試行
3. アクセス権限エラー確認
4. 各セッションディレクトリの権限設定確認

**期待結果**:
- セッション間でファイル直接アクセス不可
- ディレクトリ権限700設定確認
- ファイル権限644設定確認

**合格基準**: セキュリティ侵害0件

### TC-002-02: sessions.json暗号化保存テスト  
**目的**: チャンネルID暗号化保存確認  
**前提条件**: 複数セッション設定済み  
**手順**:
1. sessions.jsonファイル内容確認
2. チャンネルIDが平文でない事確認
3. デコード機能での正常読み込み確認
4. 不正ファイル改変時のエラー確認

**期待結果**:
- チャンネルID暗号化保存
- 正常デコードで機能動作
- 改変検出でエラー

**合格基準**: 暗号化強度確認 + 改変検出100%

### TC-002-03: セッション自動復旧機能テスト
**目的**: 異常終了時の自動復旧確認  
**前提条件**: セッション正常稼働中  
**手順**:
1. セッション2のtmuxプロセス強制終了
2. TmuxManagerによる異常検出確認
3. `./bin/vai recover 2` 実行
4. セッション2復旧確認
5. 3回リトライ動作確認

**期待結果**:
- 異常検出3秒以内
- 復旧コマンド実行成功
- リトライ機構正常動作

**合格基準**: 復旧成功率95%以上

### TC-002-04: 添付ファイル競合自動解決テスト
**目的**: 同名ファイル競合時の自動解決確認  
**前提条件**: 複数セッション稼働中  
**手順**:
1. セッション1,2で同名ファイル同時アップロード
2. タイムスタンプ付きリネーム確認
3. 両ファイルが正常保存確認
4. メタデータ記録確認

**期待結果**:
- 同名ファイル自動リネーム
- タイムスタンプ付与正常
- メタデータ記録完了

**合格基準**: ファイル損失0件

## TC-003: パフォーマンス・リソース管理テスト (SC-003対応)

### TC-003-01: Discord応答時間テスト  
**目的**: 3秒以内応答90%達成確認  
**前提条件**: 4セッション稼働中  
**手順**:
1. 各セッションに100回メッセージ送信
2. 応答時間測定（Discord送信～確認まで）
3. 統計分析（平均・90パーセンタイル）
4. 3秒超過件数カウント

**期待結果**:
- 平均応答時間2秒以下
- 90%が3秒以内応答
- 5秒超過0件

**合格基準**: 3秒以内応答率90%以上

### TC-003-02: メモリ使用量制限テスト
**目的**: 2GB制限内での安定稼働確認  
**前提条件**: システム監視機能有効  
**手順**:
1. システム起動直後メモリ使用量記録
2. 4セッション24時間稼働
3. 1時間毎メモリ使用量記録
4. メモリリーク検出分析

**期待結果**:
- 最大メモリ使用量2GB以下
- メモリリーク0MB/hour
- スワップ使用量0MB維持

**合格基準**: 24時間メモリ使用量2GB以下

### TC-003-03: 同時20ファイル処理テスト
**目的**: 高負荷時の安定性確認  
**前提条件**: 4セッション稼働中  
**手順**:
1. 各セッションに5ファイル同時アップロード（計20ファイル）
2. 処理時間測定
3. エラー率測定
4. リソース使用量監視

**期待結果**:
- 全20ファイル正常処理
- 処理時間30秒以内
- CPU使用率80%以下維持

**合格基準**: エラー率0% + 30秒以内処理

### TC-003-04: リソース監視・アラート機能テスト
**目的**: 監視機能の正常動作確認  
**前提条件**: 監視機能有効  
**手順**:
1. CPU使用率意図的上昇（90%超）
2. アラート発火確認
3. メモリ使用率意図的上昇（1.8GB超）
4. Discord通知送信確認

**期待結果**:
- 閾値超過時アラート発火
- Discord通知正常送信
- ログ記録完了

**合格基準**: 監視精度95%以上

## TC-004: 運用性・安定性テスト (SC-004対応)

### TC-004-01: 全セッション詳細状態確認テスト
**目的**: vai statusコマンドの正確性確認  
**前提条件**: 複数セッション稼働  
**手順**:
1. `./bin/vai status` 実行
2. 表示情報と実際状態比較
3. セッション追加後の表示更新確認
4. 異常セッション時の表示確認

**期待結果**:
- 全セッション状態正確表示
- リアルタイム状態同期
- 異常時の適切な警告表示

**合格基準**: 状態表示精度100%

### TC-004-02: セッション別ファイルクリーンアップテスト
**目的**: 独立クリーンアップ機能確認  
**前提条件**: 各セッションに古いファイル存在  
**手順**:
1. セッション1のみクリーンアップ実行
2. セッション1ファイル削除、他セッション保持確認
3. 全セッションクリーンアップ実行
4. 全セッションファイル削除確認

**期待結果**:
- セッション別独立クリーンアップ
- 誤削除0件
- ログ記録完了

**合格基準**: ファイル誤削除0件

### TC-004-03: 24時間連続稼働安定性テスト  
**目的**: 長期稼働での安定性確認  
**前提条件**: 4セッション初期稼働  
**手順**:
1. システム監視開始（24時間）
2. 定期ヘルスチェック（30分毎）
3. リソース使用量記録（1時間毎）
4. エラーログ監視

**期待結果**:
- 24時間連続稼働達成
- ダウンタイム0分
- 重大エラー0件

**合格基準**: 稼働率99.9%以上

### TC-004-04: 既存Session 1影響度テスト
**目的**: 既存機能への影響なし確認  
**前提条件**: マルチセッション機能有効  
**手順**:
1. セッション1での従来操作実行
2. 応答時間・機能比較（実装前後）
3. エラー率比較
4. ユーザー体験比較

**期待結果**:
- 応答時間変化±5%以内
- エラー率変化なし
- 従来機能完全保持

**合格基準**: 既存機能パフォーマンス劣化なし

## TC-005: 監視・ログ機能テスト (SC-005対応)

### TC-005-01: セッション別操作ログテスト
**目的**: セッション別ログ記録確認  
**前提条件**: ログ機能有効  
**手順**:
1. 各セッションで異なる操作実行
2. ログファイル分離確認
3. ログ形式・内容確認
4. ローテーション機能確認

**期待結果**:
- セッション別ログファイル生成
- 標準形式でログ記録
- 自動ローテーション実行

**合格基準**: ログ記録精度100%

### TC-005-02: リソース使用率監視テスト
**目的**: 5分間隔監視の正常動作確認  
**前提条件**: リソース監視有効  
**手順**:
1. 監視機能開始
2. 5分間隔でのデータ収集確認
3. 閾値超過時のアラート確認
4. データ蓄積・保存確認

**期待結果**:
- 5分±10秒間隔で監視実行
- データ正常蓄積
- 閾値超過時アラート発火

**合格基準**: 監視間隔精度95%以上

### TC-005-03: 監査ログ記録テスト  
**目的**: 重要操作の監査ログ確認  
**前提条件**: 監査ログ機能有効  
**手順**:
1. セッション追加・削除操作実行
2. チャンネルID変更操作実行
3. 監査ログ記録確認
4. ログ改竄防止機能確認

**期待結果**:
- 全重要操作のログ記録
- タイムスタンプ・操作者記録
- 改竄防止機能動作

**合格基準**: 監査ログ記録率100%

### TC-005-04: Discord警告通知テスト
**目的**: 異常時Discord通知確認  
**前提条件**: Discord通知機能有効  
**手順**:
1. CPU使用率90%超過状態作成
2. メモリ使用率80%超過状態作成
3. Discord通知送信確認
4. 通知内容・形式確認

**期待結果**:
- 閾値超過時即座通知送信
- 適切な警告レベル設定
- 通知内容詳細・正確

**合格基準**: 通知送信率100%

## TC-006: 拡張性検証テスト (SC-006対応)

### TC-006-01: セッション5動的追加テスト
**目的**: 5番目セッションの動的追加確認  
**前提条件**: 4セッション稼働中  
**手順**:
1. `./bin/vai add-session 5555555555555555555` 実行
2. sessions.json更新確認
3. session_5/ディレクトリ作成確認
4. セッション5での操作実行確認

**期待結果**:
- sessions.json即座更新
- session_5/自動作成
- セッション5正常稼働

**合格基準**: 追加成功率100%

### TC-006-02: session_5/ディレクトリ自動作成テスト
**目的**: 新セッション用ディレクトリ自動作成確認  
**前提条件**: セッション5追加完了  
**手順**:
1. session_5/存在確認
2. ディレクトリ権限確認（700）
3. 添付ファイル保存テスト
4. クリーンアップ機能確認

**期待結果**:
- session_5/正常作成
- 適切な権限設定
- 添付ファイル正常動作

**合格基準**: ディレクトリ機能100%正常

### TC-006-03: sessions.json動的エントリ追加テスト  
**目的**: 設定ファイル動的更新確認  
**前提条件**: JSON管理機能有効  
**手順**:
1. sessions.jsonバックアップ作成
2. セッション追加実行
3. JSONファイル更新確認
4. フォーマット・整合性確認

**期待結果**:
- JSON構造保持
- 新エントリ正常追加
- バックアップ機能動作

**合格基準**: JSON整合性100%維持

### TC-006-04: 10セッション段階的拡張テスト
**目的**: 大規模拡張での安定性確認  
**前提条件**: 基本システム稼働  
**手順**:
1. セッション5～10段階的追加
2. 各段階での動作確認
3. リソース使用量監視
4. 全セッション並行稼働確認

**期待結果**:
- 10セッション全稼働
- リソース使用量線形増加
- エラー率5%以下

**合格基準**: 10セッション安定稼働30分以上

### TC-006-05: 拡張後全セッション並行稼働テスト  
**目的**: 拡張後の総合動作確認  
**前提条件**: 10セッション設定済み  
**手順**:
1. 全10セッションで同時操作実行
2. 各セッション応答時間測定
3. セッション間独立性確認
4. システムリソース使用量確認

**期待結果**:
- 全セッション3秒以内応答
- セッション間影響なし
- システム安定稼働

**合格基準**: 全セッション同時稼働成功

## 🛠️ テスト実装・実行計画

### テストツール・フレームワーク
- **pytest**: Python単体・統合テスト
- **bash script**: システムレベルテスト  
- **tmux**: セッション管理テスト
- **htop/ps**: リソース監視
- **custom script**: パフォーマンス測定

### テストデータ管理
```
tests/
├── unit/                 # 単体テスト
├── integration/          # 統合テスト  
├── performance/          # パフォーマンステスト
├── security/            # セキュリティテスト
├── fixtures/            # テストデータ
├── mocks/               # モックデータ
└── reports/             # テスト結果
```

### 実行順序・スケジュール
1. **Phase 1**: 単体テスト（TC-001, TC-005一部）
2. **Phase 2**: 統合テスト（TC-001, TC-002）  
3. **Phase 3**: パフォーマンステスト（TC-003）
4. **Phase 4**: 安定性テスト（TC-004）
5. **Phase 5**: 拡張性テスト（TC-006）

### 合格基準サマリー
- **機能テスト**: 100%成功
- **セキュリティテスト**: 侵害0件
- **パフォーマンステスト**: 応答時間90%が3秒以内
- **安定性テスト**: 24時間稼働率99.9%
- **監視テスト**: ログ記録率100%
- **拡張性テスト**: 10セッション安定稼働

### テスト自動化・CI統合
```bash
# テスト実行コマンド
./test-suite/run-all-tests.sh           # 全テスト実行
./test-suite/run-sc-tests.sh SC-001     # 特定成功基準テスト
./test-suite/run-performance.sh         # パフォーマンステスト
./test-suite/run-stability.sh           # 24時間安定性テスト
```

## 📊 テスト完了基準

### 最終合格条件
✅ **全テストケース実行完了**  
✅ **SC-001～006全成功基準クリア**  
✅ **重大バグ0件**  
✅ **パフォーマンス要件達成**  
✅ **24時間安定稼働確認**  
✅ **拡張性テスト合格**

**テスト設計書承認後、テスト実装・実行フェーズに移行**