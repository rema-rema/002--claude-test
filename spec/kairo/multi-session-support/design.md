# ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ è¨­è¨ˆæ›¸

## ğŸ“‹ æ¦‚è¦

### è¨­è¨ˆç›®çš„
yamkz/claude-discord-bridgeã«å¯¾ã—ã¦ã€è¤‡æ•°Discordãƒãƒ£ãƒ³ãƒãƒ«ã§ã®ä¸¦è¡Œé–‹ç™ºã‚’å¯èƒ½ã«ã™ã‚‹ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹

### è¨­è¨ˆç¯„å›²
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- Attachmentsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ†é›¢è¨­è¨ˆ
- å‹•çš„ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹¡å¼µãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
- ã‚¨ãƒ©ãƒ¼å¾©æ—§ãƒ»ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Discord Server                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Channel #1 â”‚Channel A â”‚Channel B â”‚Channel C       â”‚
â”‚(æ—¢å­˜)     â”‚(Session2)â”‚(Session3)â”‚(Session4)      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚          â”‚          â”‚          â”‚
      â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Discord.py Bot Process                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        SessionManager Component          â”‚   â”‚
â”‚  â”‚  - Route messages to correct session     â”‚   â”‚
â”‚  â”‚  - Manage session lifecycle              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚          â”‚          â”‚          â”‚
      â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Session1 â”‚ Session2 â”‚ Session3 â”‚ Session4     â”‚
â”‚  tmux    â”‚  tmux    â”‚  tmux    â”‚  tmux        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Claude   â”‚ Claude   â”‚ Claude   â”‚ Claude       â”‚
â”‚ Code CLI â”‚ Code CLI â”‚ Code CLI â”‚ Code CLI     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚          â”‚          â”‚          â”‚
      â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Attachments Storage               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚session_1/â”‚session_2/â”‚session_3/â”‚session_4/ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

#### 1. SessionManagerï¼ˆæ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰
**è²¬å‹™**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```python
class SessionManager:
    def __init__(self, settings: SettingsManager):
        self.settings = settings
        self.sessions = {}  # {session_id: SessionInfo}
        self.channel_map = {}  # {channel_id: session_id}
        
    def initialize_sessions(self):
        """sessions.jsonã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿åˆæœŸåŒ–"""
        
    def add_session(self, channel_id: str) -> int:
        """æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å‹•çš„è¿½åŠ """
        
    def remove_session(self, session_id: int) -> bool:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆå°†æ¥æ‹¡å¼µï¼‰"""
        
    def get_session_by_channel(self, channel_id: str) -> Optional[int]:
        """ãƒãƒ£ãƒ³ãƒãƒ«IDã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—"""
```

#### 2. AttachmentManageræ”¹ä¿®
**å¤‰æ›´ç‚¹**: ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç®¡ç†æ©Ÿèƒ½è¿½åŠ 

```python
class StorageManager:
    def __init__(self, config_dir: Path, session_id: Optional[int] = None):
        self.config_dir = config_dir
        self.session_id = session_id
        self.attachments_dir = self._get_session_dir()
        
    def _get_session_dir(self) -> Path:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ã‚’è¿”ã™"""
        base_dir = self.config_dir / 'attachments'
        if self.session_id:
            return base_dir / f'session_{self.session_id}'
        return base_dir / 'session_1'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        
    def ensure_storage_directory(self):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆãƒ»æ¨©é™è¨­å®š"""
        self.attachments_dir.mkdir(parents=True, exist_ok=True)
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©åˆ†é›¢ï¼ˆ700æ¨©é™ï¼‰
        os.chmod(self.attachments_dir, 0o700)
```

#### 3. TmuxManageræ”¹ä¿®
**å¤‰æ›´ç‚¹**: è¤‡æ•°Claudeã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½å¼·åŒ–

```python
class TmuxManager:
    def create_claude_session(self, session_num: int) -> bool:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ã‚’æŒ‡å®šã—ã¦Claude Code CLIã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ"""
        session_name = f"claude-session-{session_num}"
        work_dir = self.settings.get_claude_work_dir()
        options = self.settings.get_claude_options()
        
        # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        cmd = f"tmux new-session -d -s {session_name} -c {work_dir}"
        
    def monitor_sessions(self) -> Dict[int, SessionStatus]:
        """å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ­»æ´»ç›£è¦–"""
        
    def recover_session(self, session_num: int, retry_count: int = 3):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è‡ªå‹•å¾©æ—§ãƒ¡ã‚«ãƒ‹ã‚ºãƒ """
```

#### 4. DiscordBotæ”¹ä¿®
**å¤‰æ›´ç‚¹**: ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
class DiscordBot:
    async def on_message(self, message):
        # ãƒãƒ£ãƒ³ãƒãƒ«IDã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ã‚’ç‰¹å®š
        session_id = self.session_manager.get_session_by_channel(
            str(message.channel.id)
        )
        
        if not session_id:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ1ï¼‰ã‚’ä½¿ç”¨
            session_id = 1
            
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ã®å‡¦ç†
        await self.process_with_session(message, session_id)
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ

### sessions.jsonæ§‹é€ 
```json
{
  "1": "1405815779198369903",  // æ—¢å­˜ãƒãƒ£ãƒ³ãƒãƒ«
  "2": "channel_a_id",          // ãƒãƒ£ãƒ³ãƒãƒ«A
  "3": "channel_b_id",          // ãƒãƒ£ãƒ³ãƒãƒ«B
  "4": "channel_c_id",          // ãƒãƒ£ãƒ³ãƒãƒ«C
  "5": "future_channel_id"      // å‹•çš„è¿½åŠ ä¾‹
}
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```
claude-discord-bridge-server/
â”œâ”€â”€ attachments/
â”‚   â”œâ”€â”€ session_1/           # æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨
â”‚   â”‚   â””â”€â”€ IMG_*.png
â”‚   â”œâ”€â”€ session_2/           # ãƒãƒ£ãƒ³ãƒãƒ«Aç”¨
â”‚   â”‚   â””â”€â”€ IMG_*.png
â”‚   â”œâ”€â”€ session_3/           # ãƒãƒ£ãƒ³ãƒãƒ«Bç”¨
â”‚   â”‚   â””â”€â”€ IMG_*.png
â”‚   â”œâ”€â”€ session_4/           # ãƒãƒ£ãƒ³ãƒãƒ«Cç”¨
â”‚   â”‚   â””â”€â”€ IMG_*.png
â”‚   â””â”€â”€ session_N/           # å‹•çš„ä½œæˆ
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ session_1.log        # ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ãƒ­ã‚°
â”‚   â”œâ”€â”€ session_2.log
â”‚   â”œâ”€â”€ session_3.log
â”‚   â””â”€â”€ session_4.log
â””â”€â”€ monitoring/
    â””â”€â”€ metrics.json         # ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ãƒ‡ãƒ¼ã‚¿
```

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

### 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ•ãƒ­ãƒ¼
```mermaid
sequenceDiagram
    participant Discord
    participant Bot
    participant SessionManager
    participant TmuxSession
    participant Claude
    
    Discord->>Bot: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«Aï¼‰
    Bot->>SessionManager: get_session_by_channel(channel_a_id)
    SessionManager-->>Bot: session_id = 2
    Bot->>TmuxSession: send_to_session_2(message)
    TmuxSession->>Claude: Claude Code CLIå®Ÿè¡Œ
    Claude-->>TmuxSession: å¿œç­”
    TmuxSession-->>Bot: çµæœ
    Bot-->>Discord: å¿œç­”é€ä¿¡ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«Aï¼‰
```

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ ãƒ•ãƒ­ãƒ¼
```mermaid
sequenceDiagram
    participant User
    participant CLI
    participant SessionManager
    participant TmuxManager
    participant Storage
    
    User->>CLI: ./bin/vai add-session channel_id
    CLI->>SessionManager: add_session(channel_id)
    SessionManager->>SessionManager: æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·æ±ºå®šï¼ˆ5ï¼‰
    SessionManager->>TmuxManager: create_claude_session(5)
    TmuxManager-->>SessionManager: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ
    SessionManager->>Storage: create_session_directory(5)
    Storage-->>SessionManager: session_5/ä½œæˆå®Œäº†
    SessionManager-->>CLI: ã‚»ãƒƒã‚·ãƒ§ãƒ³5è¿½åŠ å®Œäº†
    CLI-->>User: Success: Session 5 added
```

### 3. ã‚¨ãƒ©ãƒ¼å¾©æ—§ãƒ•ãƒ­ãƒ¼
```mermaid
sequenceDiagram
    participant Monitor
    participant SessionManager
    participant TmuxManager
    participant Discord
    
    Monitor->>TmuxManager: check_session_health()
    TmuxManager-->>Monitor: Session 3 is dead
    Monitor->>SessionManager: recover_session(3)
    SessionManager->>TmuxManager: restart_session(3)
    loop æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
        TmuxManager->>TmuxManager: create_claude_session(3)
        alt æˆåŠŸ
            TmuxManager-->>SessionManager: å¾©æ—§æˆåŠŸ
            SessionManager->>Discord: å¾©æ—§é€šçŸ¥é€ä¿¡
        else å¤±æ•—
            TmuxManager-->>SessionManager: ãƒªãƒˆãƒ©ã‚¤
        end
    end
```

## ğŸ”Œ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨­è¨ˆ

### CLI ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
```bash
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚³ãƒãƒ³ãƒ‰
./bin/vai add-session <channel_id>     # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ 
./bin/vai remove-session <session_num>  # ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
./bin/vai list-sessions                # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§
./bin/vai recover <session_num>        # æ‰‹å‹•å¾©æ—§

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ‹¡å¼µ
dp "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"                        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³
dp 2 "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"                      # ã‚»ãƒƒã‚·ãƒ§ãƒ³2æŒ‡å®š
dp N "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"                      # ã‚»ãƒƒã‚·ãƒ§ãƒ³NæŒ‡å®š
```

### Python API ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
```python
# SessionManager API
session_manager.add_session(channel_id: str) -> int
session_manager.remove_session(session_id: int) -> bool
session_manager.get_session_by_channel(channel_id: str) -> Optional[int]
session_manager.list_sessions() -> List[SessionInfo]
session_manager.recover_session(session_id: int) -> bool

# AttachmentManager API (ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œ)
attachment_manager = AttachmentManager(session_id=2)
attachment_manager.process_attachments(attachments) -> List[str]
attachment_manager.cleanup_old_files(max_age_days=1) -> int
```

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“åˆ†é›¢
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ **: å„session_N/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯700æ¨©é™
- **ãƒ—ãƒ­ã‚»ã‚¹åˆ†é›¢**: tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ã®ãƒ¡ãƒ¢ãƒªåˆ†é›¢
- **ãƒ­ã‚°åˆ†é›¢**: session_N.logã§ã®å€‹åˆ¥ãƒ­ã‚°ç®¡ç†

### 2. ãƒãƒ£ãƒ³ãƒãƒ«IDä¿è­·
```python
class SecureSettingsManager(SettingsManager):
    def _encrypt_channel_id(self, channel_id: str) -> str:
        """AES-256æš—å·åŒ–å®Ÿè£…"""
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æš—å·åŒ–ã‚­ãƒ¼ã‚’å–å¾—
        key = os.environ.get('ENCRYPTION_KEY')
        # Fernetæš—å·åŒ–ã‚’ä½¿ç”¨
        
    def _decrypt_channel_id(self, encrypted: str) -> str:
        """å¾©å·åŒ–å®Ÿè£…"""
```

### 3. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
```python
def validate_session_access(user_id: str, session_id: int) -> bool:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™æ¤œè¨¼"""
    # Discordæ¨©é™ãƒã‚§ãƒƒã‚¯
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯
```

## ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆ

### ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™å®Ÿè£…
```python
class ResourceMonitor:
    MAX_MEMORY_PER_SESSION = 512 * 1024 * 1024  # 512MB
    MAX_TOTAL_MEMORY = 2 * 1024 * 1024 * 1024   # 2GB
    MAX_ATTACHMENTS_PER_SESSION = 250 * 1024 * 1024  # 250MB
    
    def check_limits(self, session_id: int) -> ResourceStatus:
        """ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯"""
        
    def enforce_limits(self, session_id: int):
        """åˆ¶é™è¶…éæ™‚ã®å‡¦ç†"""
        # ãƒ¡ãƒ¢ãƒªåˆ¶é™: cgroupsä½¿ç”¨
        # ãƒ‡ã‚£ã‚¹ã‚¯åˆ¶é™: quotaè¨­å®š
```

### ä¸¦è¡Œå‡¦ç†åˆ¶å¾¡
```python
class ConcurrencyController:
    def __init__(self):
        self.file_semaphore = asyncio.Semaphore(5)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³å½“ãŸã‚Š5ãƒ•ã‚¡ã‚¤ãƒ«
        self.global_semaphore = asyncio.Semaphore(20)  # å…¨ä½“20ãƒ•ã‚¡ã‚¤ãƒ«
        
    async def process_with_limit(self, coro):
        """ä¸¦è¡Œå‡¦ç†åˆ¶é™ä»˜ãå®Ÿè¡Œ"""
        async with self.global_semaphore:
            async with self.file_semaphore:
                return await coro
```

## ğŸ“ˆ ç›£è¦–ãƒ»ãƒ­ã‚°è¨­è¨ˆ

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
```python
class MetricsCollector:
    def collect_metrics(self) -> Dict:
        return {
            "timestamp": datetime.now().isoformat(),
            "sessions": {
                f"session_{i}": {
                    "status": self.get_session_status(i),
                    "memory_usage": self.get_memory_usage(i),
                    "disk_usage": self.get_disk_usage(i),
                    "response_time": self.get_avg_response_time(i)
                }
                for i in self.active_sessions
            },
            "system": {
                "total_memory": self.get_total_memory(),
                "cpu_usage": self.get_cpu_usage()
            }
        }
```

### ã‚¢ãƒ©ãƒ¼ãƒˆå®Ÿè£…
```python
class AlertManager:
    THRESHOLDS = {
        "memory_percent": 80,
        "disk_percent": 90,
        "response_time_ms": 3000
    }
    
    async def check_and_alert(self, metrics: Dict):
        """é–¾å€¤ãƒã‚§ãƒƒã‚¯ã¨Discordã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡"""
        for session_id, data in metrics["sessions"].items():
            if data["memory_usage"] > self.THRESHOLDS["memory_percent"]:
                await self.send_discord_alert(
                    f"âš ï¸ Session {session_id}: Memory usage {data['memory_usage']}%"
                )
```

## ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨å¯¾å‡¦
```python
ERROR_HANDLERS = {
    TmuxSessionError: {
        "recovery": "restart_session",
        "max_retry": 3,
        "backoff": "exponential"
    },
    AttachmentConflictError: {
        "recovery": "rename_with_suffix",
        "notification": True
    },
    ResourceLimitError: {
        "recovery": "throttle_and_queue",
        "alert": True
    },
    ChannelNotFoundError: {
        "recovery": "use_default_session",
        "log_level": "warning"
    }
}
```

### è‡ªå‹•å¾©æ—§ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
```python
class AutoRecoveryManager:
    async def recover_with_backoff(self, session_id: int, error: Exception):
        """æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãè‡ªå‹•å¾©æ—§"""
        for attempt in range(3):
            wait_time = 2 ** attempt  # 1, 2, 4ç§’
            await asyncio.sleep(wait_time)
            
            try:
                await self.recover_session(session_id)
                await self.notify_recovery_success(session_id)
                return True
            except Exception as e:
                logger.error(f"Recovery attempt {attempt+1} failed: {e}")
                
        await self.notify_recovery_failure(session_id)
        return False
```

## ğŸš€ æ‹¡å¼µæ€§è€ƒæ…®äº‹é …

### å°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ
1. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸Šé™æ’¤å»ƒ**: å‹•çš„ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç§»è¡Œ
2. **Kuberneteså¯¾å¿œ**: ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã¨ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
3. **åˆ†æ•£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: è¤‡æ•°ãƒ›ã‚¹ãƒˆã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æ•£
4. **Web UIç®¡ç†ç”»é¢**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®WebåŒ–
5. **API Gateway**: RESTful APIçµŒç”±ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è€ƒæ…®
```python
class MigrationManager:
    def migrate_existing_attachments(self):
        """æ—¢å­˜attachments/ç›´ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’session_1/ã¸ç§»è¡Œ"""
        old_files = Path("attachments").glob("IMG_*")
        session_1_dir = Path("attachments/session_1")
        session_1_dir.mkdir(exist_ok=True)
        
        for file in old_files:
            shutil.move(str(file), str(session_1_dir / file.name))
            logger.info(f"Migrated {file.name} to session_1/")
```

## ğŸ“‹ è¨­è¨ˆåˆ¤æ–­è¨˜éŒ²

### DR-001: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·æ¡ç”¨
**æ±ºå®š**: ãƒãƒ£ãƒ³ãƒãƒ«åã§ã¯ãªãã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ï¼ˆ1, 2, 3...ï¼‰ã‚’æ¡ç”¨
**ç†ç”±**: 
- ç•ªå·ã«ã‚ˆã‚‹é †åºæ€§ã¨æ‹¡å¼µæ€§
- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã®ç°¡æ½”æ€§
- tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã¨ã®æ•´åˆæ€§

### DR-002: Attachmentsåˆ†é›¢æ–¹å¼
**æ±ºå®š**: session_N/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ˆã‚‹ç‰©ç†åˆ†é›¢
**ç†ç”±**:
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã§ã®ç¢ºå®Ÿãªåˆ†é›¢
- æ¨©é™ç®¡ç†ã®ç°¡æ½”æ€§
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ã®å®¹æ˜“æ€§

### DR-003: æš—å·åŒ–ã®é¸æŠçš„å®Ÿè£…
**æ±ºå®š**: ãƒãƒ£ãƒ³ãƒãƒ«IDæš—å·åŒ–ã¯åˆæœŸå®Ÿè£…ã§ã¯ç°¡æ˜“å®Ÿè£…
**ç†ç”±**:
- é–‹ç™ºç’°å¢ƒã§ã®åˆ©ä¾¿æ€§å„ªå…ˆ
- æœ¬ç•ªç’°å¢ƒã§ã®ã¿å®Œå…¨æš—å·åŒ–
- æ®µéšçš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æ–¹é‡

---

## ğŸ“… ä½œæˆæ—¥æ™‚
2025-08-27

## ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
è¨­è¨ˆæ›¸ä½œæˆå®Œäº† - 100å›ä»®æƒ³ä¼šè­°ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡