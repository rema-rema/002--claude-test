# マルチセッション機能 要件定義書

## 📋 プロジェクト概要

### 機能名
Discord Multi-Session Support for Claude-Discord-Bridge

### 目的
複数のDiscordチャンネルで並行してClaude Code開発セッションを実行可能にする（初期3チャンネル、将来的な無制限拡張性確保）

### 背景
- 現在：単一セッション（Session 1: 1405815779198369903）のみサポート
- 課題：複数チャンネルでの並行開発ができない
- 追加課題：attachmentsディレクトリでのファイル競合問題
- 拡張要求：将来的にセッション4, 5, 6...と柔軟に追加できる設計

## 🎯 機能要件

### FR-001: 複数セッション管理
**要件**: Discord チャンネルに対応する独立セッションの作成・管理
- **詳細**: 各チャンネルが独立したClaude Code sessionを持つ
- **初期チャンネル**: 3つの新規Discordチャンネル（A, B, C）
- **セッション番号**: Session 1(既存), 2(チャンネルA), 3(チャンネルB), 4(チャンネルC)
- **拡張性**: セッション5, 6, 7...の動的追加に対応

### FR-002: セッション別添付ファイル管理
**要件**: セッション毎の独立したattachmentsディレクトリ構造
- **ディレクトリ構造**:
  ```
  attachments/
  ├── session_1/    # 既存セッション
  ├── session_2/    # チャンネルA用
  ├── session_3/    # チャンネルB用  
  ├── session_4/    # チャンネルC用
  └── session_N/    # 将来追加されるセッション（動的作成）
  ```
- **競合回避**: セッション間でのファイル名重複・誤削除を防止

### FR-003: 並行開発サポート
**要件**: 複数セッションでの同時並行開発が可能
- **詳細**: セッション1でREQUIREMENTS、セッション2でDESIGN、セッション3でIMPLEMENTATION等
- **独立性**: 各セッションは他のセッション状態に影響されない

### FR-004: セッション識別・切替
**要件**: dpコマンドでのセッション指定機能
- **既存**: `dp "メッセージ"` (デフォルトセッション)
- **拡張**: `dp 2 "メッセージ"` (セッション2指定), `dp 3 "メッセージ"` (セッション3指定), `dp N "メッセージ"` (セッションN指定)

### FR-005: セッション復旧機能
**要件**: セッション起動失敗・異常終了時の自動・手動復旧機能
- **自動復旧**: tmuxセッション死活監視、3回まで自動再起動
- **手動復旧**: `./bin/vai recover <session_number>`コマンドでの強制復旧
- **ログ記録**: 復旧試行履歴とエラー詳細のログ保存

### FR-006: 競合検出・自動解決機能  
**要件**: 添付ファイル競合・重複の検出と自動解決
- **重複検出**: 同名ファイル検出時の自動リネーム（_duplicate_N付与）
- **競合解決**: セッション間での同時ファイル操作の排他制御
- **通知機能**: 競合発生時のDiscord通知メッセージ送信

## 🏗️ 非機能要件

### NFR-001: 既存機能互換性
**要件**: 現在のSession 1の動作に影響を与えない
- **詳細**: 既存の`dp "メッセージ"`コマンドは引き続き動作
- **設定**: sessions.jsonの既存設定を保持

### NFR-002: 設定管理
**要件**: sessions.jsonでの新規セッション設定管理
- **形式**: 
  ```json
  {
    "1": "1405815779198369903",
    "2": "チャンネルAのID", 
    "3": "チャンネルBのID",
    "4": "チャンネルCのID",
    "N": "チャンネルNのID"  // 動的追加可能
  }
  ```

### NFR-003: 自動クリーンアップ対応
**要件**: セッション別のファイルクリーンアップ機能
- **詳細**: 各セッションディレクトリで独立したクリーンアップ実行
- **安全性**: 他セッション使用中ファイルの誤削除防止

### NFR-004: セッション別権限分離
**要件**: セッション間でのセキュリティ境界確立
- **アクセス制御**: 各セッションは他セッションのattachmentsへアクセス不可
- **プロセス分離**: tmuxセッション間でのメモリ・ファイルハンドル分離
- **ログ分離**: セッション別の操作ログファイル管理

### NFR-005: チャンネルID暗号化管理
**要件**: 機密情報としてのチャンネルID保護
- **暗号化**: sessions.json内チャンネルIDのAES-256暗号化保存
- **アクセス権**: 600パーミッションでの設定ファイル保護
- **監査ログ**: チャンネルID変更操作の監査ログ記録

### NFR-006: リソース使用量制限
**要件**: システムリソースの上限設定・監視
- **メモリ制限**: 各Claudeセッション最大512MB、全体2GB上限
- **tmux制限**: 初期最大8セッション（動的拡張可能、システムリソースに応じて調整）
- **ディスク制限**: attachments全体で最大1GB、セッション別250MB

### NFR-007: 監視・アラート機能
**要件**: システム状態の継続監視とアラート
- **リソース監視**: CPU・メモリ使用率の5分間隔チェック
- **セッション監視**: 各Claudeセッションの応答性監視  
- **アラート閾値**: メモリ80%、ディスク90%でDiscord警告送信

### NFR-008: 応答時間基準
**要件**: ユーザー体験品質の保証
- **Discord応答**: dpコマンド実行から応答まで3秒以内
- **ファイル処理**: 添付ファイル（8MB）のダウンロード・保存10秒以内
- **セッション切替**: セッション指定変更の反映1秒以内

### NFR-009: 並行処理制限
**要件**: 安定性確保のための同時処理数制限
- **ファイル処理**: セッション当たり最大5ファイル同時、全体20ファイル  
- **Claude接続**: セッション当たりClaude API同時接続数3まで
- **Discord送信**: 全セッション合計でDiscord API制限内（50req/sec）

### NFR-010: 拡張性・スケーラビリティ
**要件**: セッション数の動的拡張への対応
- **動的セッション作成**: `./bin/vai add-session <channel_id>`での即時セッション追加
- **attachments自動作成**: 新規セッション追加時にsession_N/ディレクトリ自動生成
- **設定ファイル拡張性**: sessions.jsonへの動的エントリ追加（制限なし）
- **リソース動的調整**: セッション数に応じたメモリ・tmux制限の自動調整

## 👥 ユーザーストーリー

### US-001: 開発者としてのマルチセッション利用
```
As a 開発者
I want 複数のDiscordチャンネルで独立した開発セッションを持ちたい
So that 異なる機能を並行して開発できる
```

**受け入れ条件:**
- チャンネルAで機能Xの要件定義を実施
- 同時にチャンネルBで機能Yの実装作業を実施
- セッション間でファイルや状態の競合が発生しない

### US-002: プロジェクト管理者としてのセッション管理
```
As a プロジェクト管理者  
I want 各セッションの状態を独立して確認したい
So that プロジェクト全体の進捗を把握できる
```

**受け入れ条件:**
- `./bin/vai status`で全セッションの状態確認
- 各セッションの添付ファイル使用状況確認
- セッション別のClaude Code接続状態確認

## 🚫 制約事項

### C-001: 現在のアーキテクチャ制約
- yamkz/claude-discord-bridge の既存実装に基づく拡張
- Python環境での実装（Discord.py, Flask, tmux）
- 既存の設定ファイル構造（.env, sessions.json）の活用

### C-002: Codespacesリソース制約
- tmuxセッション数の制限考慮
- Codespacesメモリ・CPU使用量の考慮
- ポート使用の最適化

### C-003: Discordチャンネル制約
- 各チャンネルIDの事前取得が必要
- Discord APIの制限内での実装
- チャンネル権限設定の考慮

## 📋 前提条件

### P-001: 環境前提
- yamkz/claude-discord-bridge が正常稼働中
- Discord チャンネル A, B, C が作成済み
- 各チャンネルのIDが取得済み

### P-002: 技術前提  
- 現在のattachment_manager.pyの理解
- sessions.json形式の理解
- tmux session管理の理解

## 🎯 成功基準

### SC-001: 基本機能
- [ ] 初期4つのセッション（1, 2, 3, 4）が同時稼働
- [ ] 各セッションで独立したClaude Code操作が可能
- [ ] セッション別attachmentsディレクトリが機能（session_N形式）
- [ ] dpコマンドでのセッション指定送信（dp 2, dp 3, dp 4...N）
- [ ] セッション5以降の動的追加が可能

### SC-002: セキュリティ・復旧機能  
- [ ] セッション間でのファイルアクセス権分離
- [ ] sessions.jsonチャンネルIDの暗号化保存
- [ ] セッション異常終了時の自動復旧機能
- [ ] 添付ファイル競合の自動解決機能

### SC-003: パフォーマンス・リソース管理
- [ ] Discord応答時間3秒以内を90%以上達成
- [ ] メモリ使用量が制限値（2GB）内で安定稼働
- [ ] 同時20ファイル処理での安定性確認  
- [ ] リソース監視・アラート機能の正常動作

### SC-004: 運用性・安定性
- [ ] `./bin/vai status`で全セッション詳細状態確認（4セッション以上対応）
- [ ] セッション別ファイルクリーンアップの独立実行
- [ ] 24時間連続稼働での安定性確認（リソースリーク無し）
- [ ] 既存Session 1の動作に影響なし

### SC-005: 監視・ログ機能
- [ ] セッション別操作ログの正常記録
- [ ] リソース使用率監視の5分間隔実行  
- [ ] 監査ログ（チャンネルID変更等）の記録
- [ ] Discord警告通知の正常送信（閾値超過時）

### SC-006: 拡張性検証
- [ ] セッション5の動的追加成功
- [ ] session_5/ディレクトリの自動作成
- [ ] sessions.jsonへの動的エントリ追加確認
- [ ] 10セッションまでの段階的拡張テスト
- [ ] 拡張後の全セッション並行稼働確認

## 📝 備考

### 関連メモリ
- `claude-discord-bridge-multi-session-requirements`: 既存の競合問題分析
- `kairo-independent-mode-management-system`: モード管理システム設計

### 実装優先度
**高**: セッション追加機能、attachmentsセッション別分割  
**中**: dpコマンド拡張、状態確認機能拡張
**低**: 高度な監視・ログ機能

---

## 📅 作成日時
2025-08-27

## 📊 ステータス  
要件定義作成完了 - レビュー・承認待ち