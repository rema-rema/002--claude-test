#!/usr/bin/env bash
#
# dp - Discord Postコマンド（マルチセッション対応）
# 使い方:
#   dp "message"                    # デフォルトセッション（session_1）
#   dp 2 "message"                  # セッション2
#   dp 3 "message"                  # セッション3  
#   dp 4 "message"                  # セッション4
#   dp 1234567890123456 "message"   # チャンネルID直接指定
#
# セッション管理:
#   ./bin/vai list-sessions         # 設定済みセッション確認
#   ./bin/vai add-session <ch_id>   # 新セッション追加
#

# Get toolkit root directory
TOOLKIT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Check arguments
if [ $# -eq 0 ]; then
    echo "Usage: dp [session_number or channel_id] \"message\""
    echo "Examples:"
    echo "  dp \"Hello World\"       # Send to default session"
    echo "  dp 2 \"Hello\"           # Send to session 2"
    echo "  dp 123456789 \"Hi\"      # Send to specific channel ID"
    echo ""
    echo "Session management:"
    echo "  ./bin/vai list-sessions  # View configured sessions"
    echo "  ./bin/vai add-session    # Add new session"
    exit 1
fi

# Parse arguments with enhanced validation
if [ $# -eq 1 ]; then
    # Only message provided, use default session
    MESSAGE="$1"
    if [ -z "$MESSAGE" ]; then
        echo "Error: Message cannot be empty"
        exit 1
    fi
    echo -e "$MESSAGE" | python3 "$TOOLKIT_ROOT/src/discord_post.py"
elif [ $# -eq 2 ]; then
    # Session/channel and message provided
    CHANNEL="$1"
    MESSAGE="$2"
    
    # Validate inputs
    if [ -z "$CHANNEL" ]; then
        echo "Error: Session number or channel ID cannot be empty"
        exit 1
    fi
    if [ -z "$MESSAGE" ]; then
        echo "Error: Message cannot be empty"
        exit 1
    fi
    
    # Additional validation for session numbers
    if [[ "$CHANNEL" =~ ^[0-9]+$ ]] && [ ${#CHANNEL} -lt 5 ]; then
        if [ "$CHANNEL" -lt 1 ] || [ "$CHANNEL" -gt 9999 ]; then
            echo "Error: Session number must be between 1 and 9999"
            exit 1
        fi
    fi
    
    echo -e "$MESSAGE" | python3 "$TOOLKIT_ROOT/src/discord_post.py" "$CHANNEL"
else
    echo "Error: Too many arguments"
    echo "Usage: dp [session_number or channel_id] \"message\""
    echo "Run 'dp' with no arguments for detailed help"
    exit 1
fi