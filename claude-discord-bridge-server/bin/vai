#!/usr/bin/env python3
"""
vai - Claude-Discord Bridge起動・管理コマンド
"""

import os
import sys
import subprocess
import time
from pathlib import Path

# Add parent directory to path for imports
toolkit_root = Path(__file__).parent.parent
sys.path.insert(0, str(toolkit_root))

from src.environment import EnvironmentDetector
from src.tmux_manager import TmuxManager
from src.attachment_manager import AttachmentManager
from src.session_manager import SessionManager
from config.settings import SettingsManager
from lib.utils import (
    is_service_running, create_pid_file, stop_service,
    find_available_port, is_port_in_use
)

def cmd_start():
    """サービスを起動"""
    settings = SettingsManager()
    
    # Check if configured
    if not settings.is_configured():
        print("❌ Claude-Discord Bridge is not configured.")
        print("Please run './install.sh' first.")
        sys.exit(1)
    
    # Check if already running
    if is_service_running('discord_bot') or is_service_running('flask_app'):
        print("⚠️  Services are already running.")
        print("Use 'vai status' to check status or 'vexit' to stop.")
        return
    
    print("🚀 Starting Claude-Discord Bridge...")
    
    # Start tmux session for monitoring
    tmux = TmuxManager()
    if not tmux.create_session():
        print("❌ Failed to create tmux session")
        sys.exit(1)
    
    tmux.create_panes()
    
    # Start Claude Code sessions
    work_dir = settings.get_claude_work_dir()
    claude_options = settings.get_claude_options()
    sessions = settings.list_sessions()
    
    print("  Starting Claude Code sessions...")
    for session_num, channel_id in sessions:
        if tmux.create_claude_session(session_num, work_dir, claude_options):
            time.sleep(1)  # Give each session time to start
        else:
            print(f"  ⚠️  Failed to start Claude session {session_num}")
    
    print(f"  Started {len(sessions)} Claude Code sessions")
    
    # Get paths
    src_dir = toolkit_root / 'src'
    
    # Start Discord bot in pane 0
    print("  Starting Discord bot...")
    tmux.send_command("0.0", f"cd {src_dir} && python3 discord_bot.py")
    time.sleep(2)  # Give bot time to start
    
    # Start Flask app in pane 1
    flask_port = settings.get_port('flask')
    if is_port_in_use(flask_port):
        print(f"  ⚠️  Port {flask_port} is in use, finding alternative...")
        flask_port = find_available_port(flask_port + 1)
        if flask_port is None:
            print("  ❌ No available ports found")
            sys.exit(1)
        print(f"  Using port {flask_port}")
    
    print("  Starting Flask app...")
    tmux.send_command("0.1", f"cd {src_dir} && python3 flask_app.py")
    
    # Third pane for monitoring
    tmux.send_command("0.2", "echo 'Claude-Discord Bridge - Monitoring'")
    
    print("\n✅ All services started successfully!")
    
    # Show Claude sessions
    claude_sessions = tmux.list_claude_sessions()
    if claude_sessions:
        print(f"\n🤖 Claude Code Sessions:")
        for num, session_name in claude_sessions:
            default = " ⭐ (default)" if num == settings.get_default_session() else ""
            print(f"  Session {num}: {session_name}{default}")
    
    print("\nUsage:")
    print("  vai status    - Check service status")
    print("  vai doctor    - Run environment diagnosis")
    print("  vai view      - View all sessions in one screen")
    print("  vexit         - Stop all services")
    print("  dp 'message'  - Send message to Discord")
    
    # Offer to attach to tmux
    print(f"\nTo view services: tmux attach -t {tmux.session_name}")
    if claude_sessions:
        print("To view Claude sessions:")
        for num, session_name in claude_sessions[:3]:  # Show first 3
            print(f"  tmux attach -t {session_name}")
        if len(claude_sessions) > 3:
            print(f"  ... and {len(claude_sessions) - 3} more")

def cmd_status():
    """サービスの状態を確認（マルチセッション対応）"""
    settings = SettingsManager()
    tmux = TmuxManager()
    session_manager = SessionManager()
    
    print("📊 Claude-Discord Bridge Multi-Session Status")
    print("=" * 50)
    
    # Configuration
    print("\n⚙️  Configuration:")
    print(f"  Configured: {'✅ Yes' if settings.is_configured() else '❌ No'}")
    
    # Services
    print("\n🔧 Services:")
    print(f"  Discord Bot: {'✅ Running' if is_service_running('discord_bot') else '❌ Stopped'}")
    print(f"  Flask App: {'✅ Running' if is_service_running('flask_app') else '❌ Stopped'}")
    print(f"  tmux Session: {'✅ Active' if tmux.is_session_exists() else '❌ Inactive'}")
    
    # Discord Sessions with SessionManager
    print("\n💬 Discord Sessions:")
    sessions = settings.list_sessions()
    if sessions:
        for num, channel_id in sessions:
            default = " ⭐ (default)" if num == session_manager.get_default_session() else ""
            # セッション健康状態は TmuxManager で確認
            is_healthy = tmux.check_session_health(num) if tmux else False
            health_icon = "💚" if is_healthy else "💔"
            print(f"  Session {num}: {channel_id}{default} {health_icon}")
    else:
        print("  ❌ No sessions configured")
        print("  Run './bin/vai add-session <channel_id>' to add a session")
    
    # Claude Sessions with detailed status
    print("\n🤖 Claude Code Sessions:")
    claude_sessions = tmux.list_claude_sessions()
    if claude_sessions:
        session_stats = tmux.get_session_stats()
        print(f"  Total Active: {session_stats['active_sessions']}/{session_stats['total_sessions']}")
        
        for num, session_name in claude_sessions:
            running = "✅ Running" if tmux.is_claude_session_exists(num) else "❌ Stopped"
            detailed_status = tmux.get_session_detailed_status(num)
            
            recovery_info = ""
            if detailed_status.get('recovery_count', 0) > 0:
                recovery_info = f" (recovered {detailed_status['recovery_count']}x)"
            
            print(f"  Session {num}: {running}{recovery_info}")
            if detailed_status.get('status') == 'error':
                print(f"    ⚠️  Status: Error detected")
    else:
        print("  ❌ No Claude sessions found")
        print("  Run './bin/vai' to start sessions")
    
    # Attachment Storage - Multi-session
    print("\n📎 Attachment Storage:")
    try:
        all_sessions_info = AttachmentManager.get_all_sessions_info(settings.config_dir)
        if all_sessions_info:
            total_files = sum(info['total_files'] for info in all_sessions_info)
            total_size_mb = sum(info['total_size_mb'] for info in all_sessions_info)
            
            print(f"  Total Files: {total_files}")
            print(f"  Total Size: {total_size_mb:.2f} MB")
            print(f"  Active Sessions: {len([info for info in all_sessions_info if info['status'] == 'active'])}")
            
            # Show per-session breakdown
            for info in all_sessions_info:
                status_icon = "📁" if info['status'] == 'active' else "📂"
                print(f"    Session {info['session_id']}: {info['total_files']} files ({info['total_size_mb']}MB) {status_icon}")
        else:
            print("  📂 No attachment directories found")
    except Exception as e:
        print(f"  ❌ Error getting storage info: {e}")
    
    # Ports
    flask_port = settings.get_port('flask')
    print(f"\n🔌 Ports:")
    print(f"  Flask: {flask_port} {'✅ Available' if not is_port_in_use(flask_port) else '❌ In use'}")
    
    # Summary
    print(f"\n📊 Summary:")
    active_claude = len(claude_sessions) if claude_sessions else 0
    configured_sessions = len(sessions) if sessions else 0
    print(f"  Configured Sessions: {configured_sessions}")
    print(f"  Active Claude Sessions: {active_claude}")
    
    if configured_sessions > 0 and active_claude == 0:
        print(f"  💡 Tip: Run './bin/vai' to start Claude Code sessions")

def cmd_doctor():
    """環境診断を実行"""
    detector = EnvironmentDetector()
    is_healthy = detector.print_diagnosis()
    sys.exit(0 if is_healthy else 1)

def cmd_list_sessions():
    """セッション一覧を表示"""
    settings = SettingsManager()
    sessions = settings.list_sessions()
    
    if not sessions:
        print("No sessions configured.")
        return
    
    print("📋 Configured Sessions:")
    print("=" * 40)
    default_session = settings.get_default_session()
    
    for num, channel_id in sessions:
        default = " ⭐ (default)" if num == default_session else ""
        print(f"Session {num}: {channel_id}{default}")

def cmd_add_session(channel_id: str):
    """新しいセッションを追加（SessionManager使用）"""
    session_manager = SessionManager()
    
    # Validate channel ID
    if not channel_id.isdigit() or len(channel_id) < 15:
        print("❌ Invalid channel ID format")
        print("Channel IDs should be 15-20 digit numbers")
        return
    
    # Check if already exists
    existing_session = session_manager.get_session_by_channel(channel_id)
    if existing_session:
        print(f"⚠️  Channel {channel_id} is already configured as session {existing_session}")
        return
    
    try:
        # Add session using SessionManager
        session_id = session_manager.add_session(channel_id)
        print(f"✅ Added channel {channel_id} as session {session_id}")
        
        # Create attachments directory for new session
        attachment_manager = AttachmentManager(session_id=session_id)
        print(f"📁 Created attachments directory: session_{session_id}/")
        
        # Update sessions list in memory if bot is running
        if is_service_running('discord_bot'):
            print("ℹ️  Restart the bot to use the new session")
            
    except Exception as e:
        print(f"❌ Failed to add session: {e}")

def cmd_remove_session(session_arg: str):
    """セッションを削除（SessionManager使用）"""
    session_manager = SessionManager()
    
    # Validate session number
    if not session_arg.isdigit():
        print("❌ Invalid session number format")
        print("Usage: vai remove-session <session_number>")
        return
    
    session_id = int(session_arg)
    
    # Check if session exists
    if not session_manager.is_session_active(session_id):
        print(f"❌ Session {session_id} not found or not active")
        return
    
    # Check if it's the default session
    if session_id == session_manager.get_default_session():
        print("❌ Cannot remove default session")
        return
    
    try:
        # Remove session
        success = session_manager.remove_session(session_id)
        if success:
            print(f"✅ Removed session {session_id}")
            print("ℹ️  Restart the bot to apply changes")
        else:
            print(f"❌ Failed to remove session {session_id}")
    except Exception as e:
        print(f"❌ Error removing session: {e}")

def cmd_recover_session(session_arg: str):
    """セッション復旧（SessionManager使用）"""
    session_manager = SessionManager()
    tmux = TmuxManager()
    settings = SettingsManager()
    
    # Validate session number
    if not session_arg.isdigit():
        print("❌ Invalid session number format")
        print("Usage: vai recover <session_number>")
        return
    
    session_id = int(session_arg)
    
    # Check if session exists in configuration
    if not session_manager.is_session_active(session_id):
        print(f"❌ Session {session_id} not found in configuration")
        return
    
    try:
        print(f"🔧 Recovering session {session_id}...")
        
        # Kill existing tmux session if it exists
        if tmux.is_claude_session_exists(session_id):
            print(f"  Killing existing tmux session...")
            tmux.kill_claude_session(session_id)
            time.sleep(1)
        
        # Create new Claude session
        work_dir = settings.get_claude_work_dir()
        claude_options = settings.get_claude_options()
        
        if tmux.create_claude_session(session_id, work_dir, claude_options):
            print(f"✅ Successfully recovered session {session_id}")
            session_manager.update_session_health(session_id, True)
        else:
            print(f"❌ Failed to recover session {session_id}")
            session_manager.update_session_health(session_id, False)
            
    except Exception as e:
        print(f"❌ Error recovering session {session_id}: {e}")

def cmd_view():
    """全セッションを1画面でリアルタイム表示"""
    settings = SettingsManager()
    tmux = TmuxManager()
    
    # Check if sessions exist
    claude_sessions = tmux.list_claude_sessions()
    if not claude_sessions:
        print("❌ No Claude Code sessions are running")
        print("Run 'vai' to start sessions first")
        return
    
    print("🖥️  Setting up interactive multi-session view...")
    
    view_session = "claude-view"
    
    try:
        # Kill existing view session if it exists
        if subprocess.run(["tmux", "has-session", "-t", view_session], capture_output=True).returncode == 0:
            subprocess.run(["tmux", "kill-session", "-t", view_session], check=True)
        
        # Create new view session
        subprocess.run(["tmux", "new-session", "-d", "-s", view_session], check=True)
        
        # Setup custom key bindings for enhanced navigation
        _setup_view_keybindings(view_session)
        
        # Setup layout based on number of sessions
        num_sessions = len(claude_sessions)
        
        if num_sessions == 1:
            # Single session - link and display
            session_name = f"claude-session-{claude_sessions[0][0]}"
            _create_linked_view(view_session, "0", session_name, claude_sessions[0][0])
        
        elif num_sessions == 2:
            # Split vertically for 2 sessions
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0"], check=True)
            
            # Link both sessions
            for i, (session_num, _) in enumerate(claude_sessions[:2]):
                session_name = f"claude-session-{session_num}"
                _create_linked_view(view_session, f"0.{i}", session_name, session_num)
        
        elif num_sessions == 3:
            # 3 sessions: one large top, two bottom
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0"], check=True)
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0.1"], check=True)
            
            # Link all sessions with improved layout
            for i, (session_num, _) in enumerate(claude_sessions[:3]):
                session_name = f"claude-session-{session_num}"
                _create_linked_view(view_session, f"0.{i}", session_name, session_num)
        
        elif num_sessions == 4:
            # 4 sessions: 2x2 grid layout
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0"], check=True)
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0.0"], check=True)
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0.2"], check=True)
            
            # Link all 4 sessions
            for i, (session_num, _) in enumerate(claude_sessions[:4]):
                session_name = f"claude-session-{session_num}"
                _create_linked_view(view_session, f"0.{i}", session_name, session_num)
        
        elif num_sessions == 5 or num_sessions == 6:
            # 5-6 sessions: 3x2 grid layout
            # Create top row (3 panes)
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0"], check=True)
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0.1"], check=True)
            
            # Create bottom row (2-3 panes)
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0.0"], check=True)
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0.1"], check=True)
            
            if num_sessions == 6:
                subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0.2"], check=True)
            
            # Link all sessions
            pane_mapping = ["0.0", "0.1", "0.2", "0.3", "0.4", "0.5"]
            for i, (session_num, _) in enumerate(claude_sessions[:num_sessions]):
                session_name = f"claude-session-{session_num}"
                _create_linked_view(view_session, pane_mapping[i], session_name, session_num)
        
        elif num_sessions >= 7:
            # 7+ sessions: fallback to 6 sessions display
            print(f"⚠️  Displaying first 6 sessions out of {num_sessions}")
            
            # Same as 6 sessions layout
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0"], check=True)
            subprocess.run(["tmux", "split-window", "-h", "-t", f"{view_session}:0.1"], check=True)
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0.0"], check=True)
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0.1"], check=True)
            subprocess.run(["tmux", "split-window", "-v", "-t", f"{view_session}:0.2"], check=True)
            
            # Link first 6 sessions
            pane_mapping = ["0.0", "0.1", "0.2", "0.3", "0.4", "0.5"]
            for i, (session_num, _) in enumerate(claude_sessions[:6]):
                session_name = f"claude-session-{session_num}"
                _create_linked_view(view_session, pane_mapping[i], session_name, session_num)
        
        # Set pane titles
        subprocess.run(["tmux", "set-option", "-t", view_session, "pane-border-status", "top"])
        
        # Enable mouse support for better interaction
        subprocess.run(["tmux", "set-option", "-t", view_session, "mouse", "on"])
        
        print(f"✅ Interactive multi-session view created!")
        print(f"📺 Displaying {min(num_sessions, 6)} sessions in real-time")
        print(f"🎮 Features:")
        print(f"   • Real-time Claude Code session monitoring")
        print(f"   • Mouse support enabled")
        print(f"   • Ctrl+B + Arrow keys: Navigate between panes")
        print(f"   • Ctrl+B + S: Toggle synchronize-panes")
        print(f"   • Ctrl+B + R: Refresh all panes")
        print(f"   • Ctrl+B + F: Toggle full-screen pane")
        print(f"   • Ctrl+B + D: Detach from view")
        
        # Offer to attach immediately
        try:
            import sys
            if sys.stdin.isatty():
                response = input(f"\n🚀 Attach to interactive view now? (Y/n): ")
                if response.lower() != 'n':
                    subprocess.run(["tmux", "attach", "-t", view_session])
        except KeyboardInterrupt:
            print(f"\n📱 View session created: tmux attach -t {view_session}")
            
    except subprocess.CalledProcessError as e:
        print(f"❌ Failed to create view session: {e}")
        print("Make sure tmux is available and sessions are running")

def _setup_view_keybindings(view_session):
    """Setup enhanced key bindings for view session"""
    # Refresh all panes
    subprocess.run([
        "tmux", "bind-key", "-T", "prefix", "r", 
        f"run-shell 'tmux list-panes -t {view_session} -F \"#{{pane_index}}\" | xargs -I {{}} tmux send-keys -t {view_session}:0.{{}} C-l'"
    ])
    
    # Toggle synchronize panes
    subprocess.run([
        "tmux", "bind-key", "-T", "prefix", "s",
        f"setw synchronize-panes"
    ])
    
    # Toggle full screen pane
    subprocess.run([
        "tmux", "bind-key", "-T", "prefix", "f",
        "resize-pane -Z"
    ])

def _create_linked_view(view_session, pane_target, claude_session, session_num):
    """Create a real-time view pane for a Claude Code session"""
    # Use direct attach for reliable real-time display
    subprocess.run([
        "tmux", "send-keys", "-t", f"{view_session}:{pane_target}",
        f"unset TMUX && tmux attach -t {claude_session}", "Enter"
    ])
    
    # Brief pause to ensure attachment
    time.sleep(0.3)
    
    # Set pane title for identification
    subprocess.run([
        "tmux", "select-pane", "-t", f"{view_session}:{pane_target}",
        "-T", f"Claude Session {session_num}"
    ])

def print_usage():
    """使用方法を表示（マルチセッション対応）"""
    print("vai - Claude-Discord Bridge Multi-Session Manager")
    print("\nCore Commands:")
    print("  vai                         Start all services")
    print("  vai status                  Check multi-session status") 
    print("  vai doctor                  Run environment diagnosis")
    print("  vai view                    View all sessions in one screen")
    print("\nSession Management:")
    print("  vai list-sessions           List configured sessions")
    print("  vai add-session <ch_id>     Add new Discord channel session")
    print("  vai remove-session <num>    Remove session (except default)")
    print("  vai recover <num>           Recover failed session")
    print("\nMessage Commands:")
    print("  dp 'message'                Send to default session")
    print("  dp <num> 'message'          Send to specific session")
    print("  dp <channel_id> 'message'   Send to specific channel")
    print("\nOther Commands:")
    print("  vexit                       Stop all services")
    print("\nExamples:")
    print("  vai add-session 1234567890123456")
    print("  vai recover 2")
    print("  dp 3 'Hello from session 3'") 

def main():
    """メイン関数"""
    if len(sys.argv) == 1:
        # No arguments - start services
        cmd_start()
    elif len(sys.argv) == 2:
        command = sys.argv[1]
        if command == 'status':
            cmd_status()
        elif command == 'doctor':
            cmd_doctor()
        elif command == 'view':
            cmd_view()
        elif command == 'list-sessions':
            cmd_list_sessions()
        elif command in ['help', '--help', '-h']:
            print_usage()
        else:
            print(f"Unknown command: {command}")
            print_usage()
            sys.exit(1)
    elif len(sys.argv) == 3:
        command = sys.argv[1]
        arg = sys.argv[2]
        if command == 'add-session':
            cmd_add_session(arg)
        elif command == 'remove-session':
            cmd_remove_session(arg)
        elif command == 'recover':
            cmd_recover_session(arg)
        else:
            print(f"Unknown command: {command}")
            print_usage()
            sys.exit(1)
    else:
        print("Invalid usage")
        print_usage()
        sys.exit(1)

if __name__ == "__main__":
    main()