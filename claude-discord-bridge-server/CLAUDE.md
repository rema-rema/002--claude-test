## Discord経由の通知に対応するルール

以下のような文言が含まれるメッセージを受け取った場合、「Discordからの通知」と判断してください：
1. 「Discordからの通知:」で始まるメッセージ
2. メッセージ末尾に `session=数字` が含まれる場合
3. スラッシュコマンド（例：`/project-analyze session=1`）

「Discordからの通知」がきた場合は以下のルールに従ってください：
### 基本的な応答ルール
1. **CLI応答は禁止。すべて`Bash`ツールを使って`dp`コマンドでメッセージを送信してください。**
2. `dp`コマンドの使用例：
   - `dp "応答メッセージ"` (デフォルトセッション)
   - `dp 2 "セッション2への応答"` (特定セッション)
   - `dp 1234567890 "チャンネルIDで直接送信"` (チャンネルID指定)

### Discord返信時のメンション
- 通常の返信にはユーザーのメンション `<@ユーザーID>` を含めてください
- メッセージの先頭に配置すること
- 引用形式（「> 」付き）での経過報告にはメンションを付けないこと

### 画像添付への対応
メッセージに `[添付画像のファイルパス: /path/to/image.png]` が含まれている場合：
1. `Read`ツールでその画像ファイルを読み込み
2. 画像の内容を分析して適切に応答
3. UI/UXレビュー、コードレビュー、ドキュメント処理などに活用

### マルチセッション対応

#### セッション指定方法
- `dp "メッセージ"` - デフォルトセッション（session_1）への送信
- `dp 2 "メッセージ"` - セッション2への送信
- `dp 3 "メッセージ"` - セッション3への送信
- `dp 4 "メッセージ"` - セッション4への送信
- `dp 1405815779198369903 "メッセージ"` - チャンネルID直接指定

#### セッション管理コマンド
- `./bin/vai status` - 全セッション状態確認
- `./bin/vai list-sessions` - セッション一覧表示
- `./bin/vai add-session <channel_id>` - 新セッション追加
- `./bin/vai remove-session <session_id>` - セッション削除
- `./bin/vai recover <session_id>` - セッション復旧

#### セッション別ディレクトリ構造
```
attachments/
├── session_1/     # セッション1専用ディレクトリ
├── session_2/     # セッション2専用ディレクトリ
├── session_3/     # セッション3専用ディレクトリ
└── session_4/     # セッション4専用ディレクトリ
```

### 出力の例

**出力例（改行含む長文対応）** 
```
dp 1 "<@ユーザー番号> {応答}\n{応答}" (Session=1の場合)
dp 2 "<@ユーザー番号> {応答}\n{応答}" (Session=2の場合)
```

### プロセス管理システム

#### 自動クリーンアップ機能
Claude-Discord Bridgeは起動時に自動的に古いプロセスをクリーンアップします：
- マーカーファイル方式（/tmp/claude-discord-bridge-*.pid）でプロセス管理
- 起動時に古いClaude Code、Discord Bot、tmuxセッション等を自動終了
- ゾンビプロセス（数日前の古いプロセス）も検知・削除

#### 環境変数による動作制御
- `CLAUDE_OPTIONS=--dangerously-skip-permissions` - 自動許可モード有効化
- `CC_CLAUDE_USER_ID` - Claude BotのユーザーID（メンション用）
- `CC_DISCORD_USER_ID` - 人間ユーザーのID（認証用）

#### プロセス健全性監視
各セッションのClaude Codeプロセスを監視し、異常終了時の自動復旧機能を提供